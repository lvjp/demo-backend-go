---

name: demo-backend-go

services:
  backend:
    build:
      context: ../..
      dockerfile: ./build/Dockerfile
    env_file: "postgres.env"
    restart: always
    ports:
      - 8081:8080
    healthcheck:
      test: ["CMD", "/app", "healthcheck"]
    depends_on:
      db-migrate:
        condition: service_completed_successfully
      db-fill:
        condition: service_completed_successfully
  swagger:
    image: swaggerapi/swagger-ui:v5.29.3@sha256:9c2688be89e275bbc80b85ffedf52883233cbd1ec4636faff3eb618b6420acf2
    restart: always
    environment:
      - SWAGGER_JSON=/opt/swagger.yaml
      - VALIDATOR_URL=none
    volumes:
      - ../../api/openapi.yaml:/opt/swagger.yaml
    ports:
      - 8082:8080
    healthcheck:
      test: ["CMD", "curl", "--head", "--fail", "--user-agent", "local-healthcheck", "http://localhost:8080"]
  db:
    image: postgres:16.8-bookworm@sha256:e95b0cb95f719e0ce156c2bc5545c89fbd98a1a692845a5331ddc79ea61f1b1e
    restart: always
    env_file: "postgres.env"
    healthcheck:
      test: ["CMD", "pg_isready"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 10s
  db-migrate:
    image: migrate/migrate:v4.19.0@sha256:d5c978181e3bfa55cc50e3bd8d7da3d87418a87693453250a8804b81ee6494db
    env_file: "postgres.env"
    entrypoint: []
    command: migrate --path=/opt/demo-backend-go/migrate --database=postgres://db:5432?sslmode=disable --verbose up
    volumes:
      - ../../database/migrate:/opt/demo-backend-go/migrate
    depends_on:
      db:
        condition: service_healthy
  db-fill:
    image: postgres:16.8-bookworm@sha256:e95b0cb95f719e0ce156c2bc5545c89fbd98a1a692845a5331ddc79ea61f1b1e
    env_file: "postgres.env"
    command: psql --host db -f /opt/demo-backend-go/db-fill.sql
    volumes:
      - ./db-fill.sql:/opt/demo-backend-go/db-fill.sql
    depends_on:
      db-migrate:
        condition: service_completed_successfully
