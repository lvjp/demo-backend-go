---

name: demo-backend-go

services:
  backend:
    build:
      context: ../..
      dockerfile: ./build/Dockerfile
    env_file: "postgres.env"
    restart: always
    ports:
      - 8081:8080
    healthcheck:
      test: ["CMD", "/app", "healthcheck"]
    depends_on:
      db-migrate:
        condition: service_completed_successfully
      db-fill:
        condition: service_completed_successfully
  swagger:
    image: swaggerapi/swagger-ui:v5.25.3@sha256:77f03599e686f6411258bce4081cc32fd981eff6c332f0db1aaeae859e08a1f1
    restart: always
    environment:
      - SWAGGER_JSON=/opt/swagger.yaml
      - VALIDATOR_URL=none
    volumes:
      - ../../api/openapi.yaml:/opt/swagger.yaml
    ports:
      - 8082:8080
    healthcheck:
      test: ["CMD", "curl", "--head", "--fail", "--user-agent", "local-healthcheck", "http://localhost:8080"]
  db:
    image: postgres:16.8-bookworm@sha256:e95b0cb95f719e0ce156c2bc5545c89fbd98a1a692845a5331ddc79ea61f1b1e
    restart: always
    env_file: "postgres.env"
    healthcheck:
      test: ["CMD", "pg_isready"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 10s
  db-migrate:
    image: migrate/migrate:v4.18.3@sha256:39b59b389634e43bb3f2d4e94bc1edef0775ec2a9a3540ce6a2cf330e5daae55
    env_file: "postgres.env"
    entrypoint: []
    command: migrate --path=/opt/demo-backend-go/migrate --database=postgres://db:5432?sslmode=disable --verbose up
    volumes:
      - ../../database/migrate:/opt/demo-backend-go/migrate
    depends_on:
      db:
        condition: service_healthy
  db-fill:
    image: postgres:16.8-bookworm@sha256:e95b0cb95f719e0ce156c2bc5545c89fbd98a1a692845a5331ddc79ea61f1b1e
    env_file: "postgres.env"
    command: psql --host db -f /opt/demo-backend-go/db-fill.sql
    volumes:
      - ./db-fill.sql:/opt/demo-backend-go/db-fill.sql
    depends_on:
      db-migrate:
        condition: service_completed_successfully
